# kubeform

A module for initializing new Kubernetes clusters via available 3rd party providers (GKE is the only implementation atm).

[![Build Status][travis-image]][travis-url]
[![Coverage Status][coveralls-image]][coveralls-url]
[![Version npm][version-image]][version-url]
[![npm Downloads][downloads-image]][downloads-url]
[![Dependencies][dependencies-image]][dependencies-url]

## Approach

### GKE

At present, the approach is to make use of a service account that has the IAM roles:

 * `roles/billing.projectManager`
 * `roles/container.clusterAdmin`
 * `roles/editor`
 * `roles/iam.roleAdmin`
 * `roles/iam.roleViewer`
 * `roles/resourcemanager.organizationAdmin`
 * `roles/resourcemanager.projectCreator`
 * `roles/resourcemanager.projectIamAdmin`

So that it can create a project per cluster and create a specialized service account for the cluster and assign it the roles required for it to do the job needed. This bypasses several security concerns that would exist if all clusters were to exist within a single project and used the top-level, default security account.

You can grant the necessary roles to a service account with the following gcloud CLI command:

```shell
gcloud organizations add-iam-policy-binding [organization id] --member serviceAccount:[full service account id] --role [role]
```

## Environment

Certain options are set via environment variables vs. the options hash or arguments:

| Variable | Description | Default |
|:-:|---|---|
| `KUBE_SERVICE` | The backing service to use for the request | `'GKE'` |
| `GOOGLE_APPLICATION_CREDENTIALS` | Path to Google API credentials file | `''` |
| `GOOGLE_ORGANIZATION_ID` | Google Organization Id to create projects under | `''` |
| `GOOGLE_BILLING_ID` | Google Billing Account Id to associate with project | `''` |

## API

### `create (options)`

Send a creation request to the underlying Kubernetes service with desired options. Returns a promise that resolves when the cluster is created or rejects if an error occurs during the initial API call or during creation.

Options is a (somewhat) sanitized hash of characteristics you want for the cluster.

```js
// defaults values for each option shown in options hash,
// omitted options will fall back to default value
// defaults are not assumed to work for general purposes,
// they exist to get you *something* but you should provide
// values that make sense for your cluster
kube.create(
  {
    name: '',
    description: '',
    locations: [], // the regions or zones to provision the master and workers in
    serviceAccount: '',
    readableBuckets: [], // existing buckets to grant the service account read access to
    writeableBuckets: [], // existing buckets to grant the service account write access to
    basicAuth: true,
    user: 'admin', // basic auth user name
    password: '', // basic auth password - UUID generated by default
    managers: 1, //
    manager: {
      distributed: false, // spread manager nodes across region (multi-zone)
    },
    worker: { // desired resourcing per worker
      cores: 2, // cores per VM/machine
      memory: '13GB', // memory followed by units in GB or MB
      count: 3, // default worker count,
      min: 3, // if autoscaling is on, a minimum and max are required
      max: 6, // if autoscaling is on, a minimum and max are required
      maxPerInstance: 4, // matches 3 x the # of workers by default, instances (or pools) are how most providers span a cluster across AZs
      reserved: true, // whether the service should assign nodes that can provide availability guarantees or not (and cost less)
      storage: {
        ephemeral: '0GB', // unreliable but usually cheaper/free storage :grimacing:
        persistent: '100GB', // how much reliable storage to attach to the instance - usually costs extra
      },
      network: {
        range: '', // give containers a CIDR range to be assigned within
        vpc: '' // set the id/name for a preset network or VPC
      }
    },
    flags: {
      alphaFeatures: false, // allow alpha features
      authedNetworksOnly: false, // only allow authorized networks to communicate with master nodes
      autoRepair: true, // service should auto-repair down/unresponsive nodes
      autoScale: false, // allow the service to detect load and scale workers up and down
      autoUpgrade: false, // allow the service to auto-upgrade kubernetes
      basicAuth: true, // allow basic auth
      clientCert: true, // generate a client cert automatically
      includeDashboard: false, // include a default installation of the kubernetes dashboard
      legacyAuthorization: false, // must be false for full RBAC
      loadBalanceHTTP: true, // required for use with Google's Cloud LB
      maintenanceWindow: '08:00:00Z', // time in UTC for when automated maint should begin
      networkPolicy: true, // turn on network policies (calico)
      privateCluster: false, // nodes do not receive public IPs and the master is inaccessible by default
      serviceMonitoring: false, // should the service perform additonal monitoring
      serviceLogging: false // should the service perform additional logging
    }
  }
)
```

### getRegions()

Returns a list of available regions.

### getZones(region)

Given a region, list the zones available.

## Long-term Goals

 * add an API to price options hash before creation
 * add support for EKS
 * add support for AKS
 * add support for kops?

[travis-image]: https://travis-ci.org/npm-wharf/kubeform.svg?branch=master
[travis-url]: https://travis-ci.org/npm-wharf/kubeform
[coveralls-url]: https://coveralls.io/github/npm-wharf/kubeform?branch=master
[coveralls-image]: https://coveralls.io/repos/github/npm-wharf/kubeform/badge.svg?branch=master
[version-image]: https://img.shields.io/npm/v/kubeform.svg?style=flat
[version-url]: https://www.npmjs.com/package/kubeform
[downloads-image]: https://img.shields.io/npm/dm/kubeform.svg?style=flat
[downloads-url]: https://www.npmjs.com/package/kubeform
[dependencies-image]: https://img.shields.io/david/npm-wharf/kubeform.svg?style=flat
[dependencies-url]: https://david-dm.org/npm-wharf/kubeform
